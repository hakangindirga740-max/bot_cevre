import os
import io
import random
import requests
import discord
from discord.ext import commands
from flask import Flask
from threading import Thread

# --- Bot TanÄ±mlamalarÄ± ---
description = "Basit matematik iÅŸlemleri yapan, kelime tÃ¼retme oyunu oynayan ve resim gÃ¶nderebilen bir Discord botu."

intents = discord.Intents.default()
intents.members = True
intents.message_content = True

bot = commands.Bot(command_prefix='?', description=description, intents=intents)

# --- Ortam DeÄŸiÅŸkenlerinden API Tokenleri ---
DISCORD_TOKEN = os.environ.get("DISCORD_TOKEN")
HUGGING_FACE_API_TOKEN = os.environ.get("HUGGING_FACE_API_TOKEN")
HUGGING_FACE_API_URL = "https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0"

# --- Kelime DosyalarÄ± ---
kelime_dosyalari = [
    "3 harfli kelimeler.txt",
    "4 harfli kelimeler.txt",
    "5 harfli kelimeler.txt",
    "6 harfli kelimeler.txt",
    "7 harfli kelimeler.txt",
    "8 harfli kelimeler.txt",
    "9 harfli kelimeler.txt"
]

def kelimeleri_yukle(dosya_adlari):
    tum_kelimeler = []
    for dosya_adi in dosya_adlari:
        try:
            with open(dosya_adi, 'r', encoding='utf-8') as f:
                kelimeler = [kelime.strip().lower() for kelime in f]
                tum_kelimeler.extend(kelimeler)
        except FileNotFoundError:
            print(f"Hata: '{dosya_adi}' dosyasÄ± bulunamadÄ±.")
        except Exception as e:
            print(f"Hata: {e}")
    return list(set(tum_kelimeler))

kelimeler = kelimeleri_yukle(kelime_dosyalari)

# --- Oyun DurumlarÄ± ---
oyun_durumu = {}
oyun_sayaci = {}
oynanan_kelimeler = {}
hata_sayisi = {}

def sonuc_yorum(sonuc: float) -> str:
    return ""  # Ä°stersen buraya emoji veya mesaj ekleyebilirsin

# --- BOT EVENTS ---
@bot.event
async def on_ready():
    print(f'Logged in as {bot.user} (ID: {bot.user.id})')
    if not kelimeler:
        print("UYARI: Kelime listesi boÅŸ!")
    else:
        print(f"Toplam {len(kelimeler)} benzersiz kelime yÃ¼klendi.")

# --- YardÄ±m ve Bilgilendirme KomutlarÄ± ---
bot.remove_command('help')

@bot.command(name='help')
async def help_command(ctx):
    help_message = (
        "Merhaba! Ben Hakan Bot :)\n"
        "\nMatematik:\n"
        " â€¢ **?topla** 12 2\n"
        " â€¢ **?Ã§Ä±kar** 12 2\n"
        " â€¢ **?Ã§arp** 12 2\n"
        " â€¢ **?bÃ¶l** 12 2\n\n"
        "Kelime TÃ¼retme Oyunu:\n"
        " â€¢ **?kelimetÃ¼ret** â†’ oyunu baÅŸlatÄ±r\n"
        " â€¢ **?k** kelime â†’ kelime girersin\n"
        " â€¢ **?oyunubÄ±rak** â†’ oyunu bitirir\n\n"
        "Resimler:\n"
        " â€¢ **?mem** â†’ klasÃ¶rden rastgele resim gÃ¶nderir\n"
        " â€¢ **?duck** â†’ rastgele Ã¶rdek resmi gÃ¶nderir\n"
        " â€¢ **?gorsel** aÃ§Ä±klama â†’ yapay zeka ile resim oluÅŸturur\n\n"
        "Bilgilendirme:\n"
        " â€¢ **?cevre** â†’ Ã§evreyi korumanÄ±n Ã¶nemi ve faydalarÄ±"
    )
    await ctx.send(help_message)

@bot.command(name="cevre")
async def cevre(ctx):
    mesaj = (
        "ğŸŒ¿ **Ã‡evreyi Korumak Neden Ã–nemlidir?**\n\n"
        "â€¢ DoÄŸal kaynaklarÄ±n korunmasÄ±na yardÄ±mcÄ± olur.\n"
        "â€¢ Hava ve su kirliliÄŸini azaltÄ±r.\n"
        "â€¢ BiyoÃ§eÅŸitliliÄŸi ve ekosistemleri korur.\n"
        "â€¢ Ä°klim deÄŸiÅŸikliÄŸi etkilerini azaltÄ±r.\n\n"
        "ğŸ’¡ **Evde yapabilecekleriniz:**\n"
        "â€¢ Geri dÃ¶nÃ¼ÅŸÃ¼m ve atÄ±k azaltma.\n"
        "â€¢ Enerji tasarrufu (LED ampul, tasarruflu cihazlar).\n"
        "â€¢ Su tasarrufu ve damla sulama kullanÄ±mÄ±.\n"
        "â€¢ Toplu taÅŸÄ±ma veya bisiklet kullanÄ±mÄ±.\n"
        "â€¢ AÄŸaÃ§ dikmek ve yeÅŸil alanlarÄ± desteklemek.\n\n"
        "ğŸŒ KÃ¼Ã§Ã¼k adÄ±mlar bÃ¼yÃ¼k fark yaratÄ±r! Herkes Ã§evreyi korumaya katkÄ±da bulunabilir."
    )
    await ctx.send(mesaj)

# --- Matematik KomutlarÄ± ---
@bot.command()
async def topla(ctx, left: int, right: int):
    await ctx.send(f"{left + right}{sonuc_yorum(left+right)}")

@bot.command()
async def Ã§Ä±kar(ctx, left: int, right: int):
    await ctx.send(f"{left - right}{sonuc_yorum(left-right)}")

@bot.command()
async def Ã§arp(ctx, left: int, right: int):
    await ctx.send(f"{left * right}{sonuc_yorum(left*right)}")

@bot.command()
async def bÃ¶l(ctx, left: int, right: int):
    if right == 0:
        await ctx.send("âŒ SÄ±fÄ±ra bÃ¶lme hatasÄ±!")
    else:
        await ctx.send(f"{left / right}{sonuc_yorum(left/right)}")

# --- Kelime TÃ¼retme Oyunu ---
@bot.command(name='kelimetÃ¼ret')
async def kelime_tÃ¼ret_baÅŸlat(ctx):
    if not kelimeler:
        await ctx.send("Kelime listesi boÅŸ!")
        return

    kanal_id = ctx.channel.id
    kullanÄ±cÄ±_id = ctx.author.id

    if kanal_id in oyun_durumu:
        await ctx.send("Oyun zaten baÅŸladÄ±!")
        return

    ilk_kelime = random.choice(kelimeler)
    oyun_durumu[kanal_id] = ilk_kelime
    oyun_sayaci[kanal_id] = 1
    oynanan_kelimeler[kanal_id] = [ilk_kelime]
    hata_sayisi[kullanÄ±cÄ±_id] = 0

    await ctx.send(f"Oyun baÅŸladÄ±! Ä°lk kelime: **{ilk_kelime.capitalize()}**")

@bot.command(name='k')
async def kelime_oyna(ctx, kelime: str):
    kanal_id = ctx.channel.id
    kullanÄ±cÄ±_id = ctx.author.id

    if kanal_id not in oyun_durumu:
        await ctx.send("Oyun baÅŸlamadÄ±. `?kelimetÃ¼ret` yazÄ±n.")
        return

    son_kelime = oyun_durumu[kanal_id]
    girilen_kelime = kelime.lower()

    if kullanÄ±cÄ±_id not in hata_sayisi:
        hata_sayisi[kullanÄ±cÄ±_id] = 0

    if girilen_kelime.startswith(son_kelime[-1]) and girilen_kelime in kelimeler and girilen_kelime not in oynanan_kelimeler[kanal_id]:
        hata_sayisi[kullanÄ±cÄ±_id] = 0
        oyun_durumu[kanal_id] = girilen_kelime
        oynanan_kelimeler[kanal_id].append(girilen_kelime)
        oyun_sayaci[kanal_id] += 1
        await ctx.send(f"DoÄŸru! Ben dÃ¼ÅŸÃ¼nÃ¼yorum...")

        gecerli_kelimeler = [k for k in kelimeler if k.startswith(girilen_kelime[-1]) and k not in oynanan_kelimeler[kanal_id]]
        if gecerli_kelimeler:
            bot_cevabi = random.choice(gecerli_kelimeler)
            oyun_durumu[kanal_id] = bot_cevabi
            oynanan_kelimeler[kanal_id].append(bot_cevabi)
            oyun_sayaci[kanal_id] += 1
            await ctx.send(f"Benim kelimem: **{bot_cevabi.capitalize()}**")
        else:
            await ctx.send("Kelime bulamadÄ±m, kazanan sensin!")
            del oyun_durumu[kanal_id]
            del oyun_sayaci[kanal_id]
            del oynanan_kelimeler[kanal_id]
            if kullanÄ±cÄ±_id in hata_sayisi:
                del hata_sayisi[kullanÄ±cÄ±_id]

    else:
        hata_sayisi[kullanÄ±cÄ±_id] += 1
        kalan = 5 - hata_sayisi[kullanÄ±cÄ±_id]
        await ctx.send(f"âŒ YanlÄ±ÅŸ! Kalan hakkÄ±n: {kalan}")
        if kalan <= 0:
            await ctx.send("5 yanlÄ±ÅŸ yaptÄ±n, ben kazandÄ±m!")
            del oyun_durumu[kanal_id]
            del oyun_sayaci[kanal_id]
            del oynanan_kelimeler[kanal_id]
            if kullanÄ±cÄ±_id in hata_sayisi:
                del hata_sayisi[kullanÄ±cÄ±_id]

@bot.command(name='oyunubÄ±rak')
async def oyunu_bitir(ctx):
    kanal_id = ctx.channel.id
    if kanal_id in oyun_durumu:
        del oyun_durumu[kanal_id]
        del oyun_sayaci[kanal_id]
        del oynanan_kelimeler[kanal_id]
        if ctx.author.id in hata_sayisi:
            del hata_sayisi[ctx.author.id]
        await ctx.send("Oyun sona erdi.")
    else:
        await ctx.send("Aktif oyun yok.")

# --- Resim KomutlarÄ± ---
resim_listesi = []

def resimleri_yukle(klasor="images"):
    try:
        if not os.path.exists(klasor):
            return []
        return [f for f in os.listdir(klasor) if f.lower().endswith((".png", ".jpg", ".jpeg", ".gif"))]
    except Exception as e:
        print(f"Resim klasÃ¶rÃ¼ne eriÅŸim hatasÄ±: {e}")
        return []

@bot.command()
async def mem(ctx):
    global resim_listesi
    klasor = "images"
    try:
        if not resim_listesi:
            resim_listesi = resimleri_yukle(klasor)
            random.shuffle(resim_listesi)

        if not resim_listesi:
            await ctx.send("âŒ 'images' klasÃ¶rÃ¼nde resim yok!")
            return

        secilen = resim_listesi.pop(0)
        dosya_yolu = os.path.join(klasor, secilen)
        with open(dosya_yolu, "rb") as f:
            picture = discord.File(f, filename=secilen)
        await ctx.send(file=picture)
    except Exception as e:
        await ctx.send(f"âš ï¸ Hata: {e}")

@bot.command(name='gorsel')
async def gorsel_olustur(ctx, *, prompt: str):
    if not HUGGING_FACE_API_TOKEN:
        await ctx.send("Hugging Face API anahtarÄ± ayarlanmamÄ±ÅŸ. LÃ¼tfen bot sahibinize ulaÅŸÄ±n.")
        return

    await ctx.send("â³ GÃ¶rsel oluÅŸturuluyor... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir.")

    try:
        headers = {"Authorization": f"Bearer {HUGGING_FACE_API_TOKEN}"}
        payload = {"inputs": prompt}

        response = requests.post(HUGGING_FACE_API_URL, headers=headers, json=payload)
        response.raise_for_status()

        image_data = response.content
        file = discord.File(fp=io.BytesIO(image_data), filename="gorsel.jpg")
        await ctx.send(file=file)

    except requests.exceptions.HTTPError as http_err:
        if http_err.response.status_code == 401:
            await ctx.send("âŒ Hata: API anahtarÄ±nÄ±z geÃ§ersiz veya eksik.")
        elif http_err.response.status_code == 503:
            await ctx.send("âŒ Model ÅŸu anda indiriliyor veya yoÄŸun. LÃ¼tfen birkaÃ§ saniye sonra tekrar deneyin.")
        elif http_err.response.status_code == 404:
            await ctx.send("âŒ Hata: Belirtilen model bulunamadÄ± veya artÄ±k geÃ§erli deÄŸil. LÃ¼tfen bot sahibinize danÄ±ÅŸÄ±n.")
        else:
            await ctx.send(f"âŒ HTTP hatasÄ± oluÅŸtu: {http_err}")
    except requests.exceptions.RequestException as req_err:
        await ctx.send(f"âŒ GÃ¶rsel oluÅŸturma sÄ±rasÄ±nda bir aÄŸ hatasÄ± oluÅŸtu: {req_err}")
    except Exception as e:
        await ctx.send(f"âš ï¸ Beklenmeyen bir hata oluÅŸtu: {e}")

# --- Basit Web Sunucu (Render iÃ§in 7/24 Ã§alÄ±ÅŸmasÄ± iÃ§in) ---
app = Flask('')

@app.route('/')
def home():
    return "Bot Ã§alÄ±ÅŸÄ±yor!"

def run():
    app.run(host='0.0.0.0', port=8080)

Thread(target=run).start()

# --- BOTU BAÅLAT ---
bot.run(DISCORD_TOKEN)
